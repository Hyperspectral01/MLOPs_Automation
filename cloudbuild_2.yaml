steps:
- name: 'ubuntu'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "DEBUG: REGION=$_REGION"
      echo "DEBUG: CLUSTER=$_CLUSTER"

- name: 'gcr.io/cloud-builders/docker'
  id: Build DB App Image
  args:
    [
      'build',
      '-t', 'gcr.io/mlops-476802/dbapp:$SHORT_SHA',
      '.'
    ]
  dir: 'dbapp'

- name: 'gcr.io/cloud-builders/docker'
  id: Build ML App Image
  args:
    [
      'build',
      '-t', 'gcr.io/mlops-476802/mlapp:$SHORT_SHA',
      '.'
    ]
  dir: 'mlapp'

- name: 'gcr.io/cloud-builders/docker'
  id: Build Web App Image
  args:
    [
      'build',
      '-t', 'gcr.io/mlops-476802/webapp:$SHORT_SHA',
      '.'
    ]
  dir: 'webapp'


# -------------------------------------------------------------
# 2Ô∏è‚É£ Push images to GCR
# -------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  id: Push DB App Image
  args: ['push', 'gcr.io/mlops-476802/dbapp:$SHORT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: Push ML App Image
  args: ['push', 'gcr.io/mlops-476802/mlapp:$SHORT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: Push Web App Image
  args: ['push', 'gcr.io/mlops-476802/webapp:$SHORT_SHA']


# -------------------------------------------------------------
# 3Ô∏è‚É£ Apply Kubernetes manifests for orchestration
# -------------------------------------------------------------
- name: 'gcr.io/cloud-builders/kubectl'
  id: Apply ConfigMap 2
  args: ['apply', '-f', 'k8s/confmap_2.yaml']
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

- name: 'gcr.io/cloud-builders/gcloud'
  id: Apply DB App Deployment
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      apt-get update && apt-get install -y gettext-base
      export SHORT_SHA=$SHORT_SHA
      envsubst < k8s/dbapp.yaml | kubectl apply -f -
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

- name: 'gcr.io/cloud-builders/gcloud'
  id: Apply ML App Deployment
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      apt-get update && apt-get install -y gettext-base
      export SHORT_SHA=$SHORT_SHA
      envsubst < k8s/mlapp.yaml | kubectl apply -f -
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

- name: 'gcr.io/cloud-builders/gcloud'
  id: Apply Web App Deployment
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      apt-get update && apt-get install -y gettext-base
      export SHORT_SHA=$SHORT_SHA
      envsubst < k8s/webapp.yaml | kubectl apply -f -
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

# -------------------------------------------------------------
# 4Ô∏è‚É£ Prometheus Monitoring Setup
# -------------------------------------------------------------
- name: 'gcr.io/cloud-builders/kubectl'
  id: Apply Prometheus ConfigMap
  args: ['apply', '-f', 'k8s/prometheus-configmap.yaml']
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

- name: 'gcr.io/cloud-builders/kubectl'
  id: Apply Prometheus Deployment
  args: ['apply', '-f', 'k8s/prometheus-deployment.yaml']
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

- name: 'gcr.io/cloud-builders/kubectl'
  id: Apply Prometheus Service
  args: ['apply', '-f', 'k8s/prometheus-service.yaml']
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'

# -------------------------------------------------------------
# 5Ô∏è‚É£ Apply Ingress for public routing
# -------------------------------------------------------------
- name: 'gcr.io/cloud-builders/kubectl'
  id: Apply Ingress
  args: ['apply', '-f', 'k8s/ingress.yaml']
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'


# -------------------------------------------------------------
# 6Ô∏è‚É£ Verify Deployment Status
# -------------------------------------------------------------
- name: 'gcr.io/cloud-builders/kubectl'
  id: Verify Pods
  args:
    - 'get'
    - 'pods'
    - '--namespace=web'
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=$_REGION'
    - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER'


# -------------------------------------------------------------
# üß© Substitutions
# -------------------------------------------------------------
substitutions:
  _REGION: us-central1-a        # change this to your GKE region or zone
  _CLUSTER: mlops-cluster    # change this to your actual cluster name


# -------------------------------------------------------------
# üíæ Image tracking (build outputs)
# -------------------------------------------------------------
images:
  - 'gcr.io/mlops-476802/dbapp:$SHORT_SHA'
  - 'gcr.io/mlops-476802/mlapp:$SHORT_SHA'
  - 'gcr.io/mlops-476802/webapp:$SHORT_SHA'

options:
 logging: CLOUD_LOGGING_ONLY